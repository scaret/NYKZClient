script
  :coffeescript(bare=true)
    friendly_time = (time_stamp)->
      now_d = new Date()
      ct = now_d.getTime()/1000 - parseInt time_stamp
      if ct < 0 or ct > 60*60*24*7
        return new Date(time_stamp*1000).toLocaleDateString()
      else if ct < 60
        return "#{Math.floor(ct)}秒前"
      else if ct < 60*60
        return "#{Math.floor(ct/60)}分钟前"
      else if ct < 60*60*24
         return "#{Math.floor(ct/60/60)}小时前"
       else
          return "#{Math.floor(ct/60/60/24)}天前"
    gotoPost = (board)->
      ()->
        postNo = parseInt prompt "转到 " + board+ " 板第几帖"
        if postNo > 0
          window.location.href = "#/board/" + board + "/start/" + postNo
    boardBlacklist = []

    updatecsrf = (callback)->
      $.get(csrfurl).success (data)->
        window.csrftoken = data
        $.ajaxSetup {headers:{"X-CSRF-token": data}}
        callback()
        data

    login = (callback)->
      console.log "login..."
      updatecsrf ->
        if(window.localStorage && window.localStorage.username && window.localStorage.pw)
          user = window.localStorage.username
          pw = window.localStorage.pw
          header = {"X-CSRF-token": window.csrftoken}
          $.post("#{endpointurl}/nykzUser/login", {user,pw})
          .success (data)->
            callback null, data
            updatecsrf ->
          .fail (data)->
            callback data,null

    doPost = (data,callback)->
      updatecsrf ->
        $.post("#{endpointurl}/nykzPost/#{data.board}", data)
        .success (data)->
          callback null, data
        .fail (data)->
          callback data,null

    isFirstOpen = ->
      if window.localStorage
        if window.localStorage.notFirstOpen
          return false
        else
          window.localStorage.notFirstOpen = "Yes"
          window.isFirstOpen = ->
            true
          return true
